/*1312167618,169776318*/

if (window.CavalryLogger) { CavalryLogger.start_js(["0srTj"]); }

function RenderManager(a){copy_properties(this,{_isDirty:false,_obj:a});}copy_properties(RenderManager.prototype,{dirty:function(){if(!this._isDirty){this._isDirty=true;bind(this,this.doPaint).defer();}},doPaint:function(){this._isDirty=false;this._obj.paint();}});
function CounterDisplay(a,g,h,e,d,b){copy_properties(this,{_name:a,_valueNode:$(g),_wrapperNode:$(h)||null,_statusClass:d,_rm:new RenderManager(this),_arbiterSubscription:null,_count:0});var c=this._valueNode.firstChild;if(c){var f=parseInt(c.nodeValue,10);if(!isNaN(f))this._count=f;}this._statusNode=e?$(e):null;this._subscribeAll();CounterDisplay.instances.push(this);if(!b)onleaveRegister(this._destroy.bind(this),true);}copy_properties(CounterDisplay,{EVENT_TYPE_ADJUST:'CounterDisplay/adjust',EVENT_TYPE_UPDATE:'CounterDisplay/update',instances:[],adjustCount:function(a,b){Arbiter.inform(CounterDisplay.EVENT_TYPE_ADJUST+'/'+a,b);},setCount:function(a,b){Arbiter.inform(CounterDisplay.EVENT_TYPE_UPDATE+'/'+a,b);}});CounterDisplay.mixin({_destroy:function(){delete this._valueNode;delete this._wrapperNode;if(this._arbiterSubscription){Arbiter.unsubscribe(this._arbiterSubscription);delete this._arbiterSubscription;}CounterDisplay.instances.remove(this);},adjustCount:function(a){this._count=Math.max(0,this._count+a);this._rm.dirty();return this;},setCount:function(a){this._count=Math.max(0,a);this._rm.dirty();return this;},paint:function(){DOM.setContent(this._valueNode,this._count);if(this._wrapperNode)CSS.conditionClass(this._wrapperNode,'hidden_elem',this._count<=0);if(this._statusClass&&this._statusNode)CSS.conditionClass(this._statusNode,this._statusClass,this._count>0);},_subscribeAll:function(){var a=[CounterDisplay.EVENT_TYPE_ADJUST+'/'+this._name,CounterDisplay.EVENT_TYPE_UPDATE+'/'+this._name];this._arbiterSubscription=Arbiter.subscribe(a,this._onInform.bind(this),Arbiter.SUBSCRIBE_NEW);},_onInform:function(a,b){b=parseInt(b);if(isNaN(b))return;if(a.indexOf(CounterDisplay.EVENT_TYPE_ADJUST)!=-1){this.adjustCount(b);}else if(a.indexOf(CounterDisplay.EVENT_TYPE_UPDATE)!=-1){this.setCount(b);}else return;return;}});
add_properties('Input',{getSelection:function(b){if(!document.selection)return {start:b.selectionStart,end:b.selectionEnd};var d=document.selection.createRange();if(d.parentElement()!==b)return {start:0,end:0};var c=b.value.length;if(b.tagName=='INPUT'){return {start:-d.moveStart('character',-c),end:-d.moveEnd('character',-c)};}else{var e=d.duplicate();e.moveToElementText(b);e.setEndPoint('StartToEnd',d);var a=c-e.text.length;e.setEndPoint('StartToStart',d);return {start:c-e.text.length,end:a};}},setSelection:function(d,f,c){if(typeof c=='undefined')c=f;if(document.selection){if(d.tagName=='TEXTAREA'){var a=(d.value.slice(0,f).match(/\r/g)||[]).length;var b=(d.value.slice(f,c).match(/\r/g)||[]).length;f-=a;c-=a+b;}var e=d.createTextRange();e.collapse(true);e.moveStart('character',f);e.moveEnd('character',c-f);e.select();}else{d.selectionStart=f;d.selectionEnd=Math.min(c,d.value.length);Input.focus(d);}}});
add_properties('Input',{enforceMaxLength:function(b,d){var h=Input.getValue(b);var c=h.length;var e=c-d;if(e>0){var f=Input.getSelection(b);var a=f.end;if(a>=e)c=a;var g=c-e;if(g&&(h.charCodeAt(g-1)&64512)===55296)g--;a=Math.min(a,g);Input.setValue(b,h.slice(0,g)+h.slice(c));Input.setSelection(b,Math.min(f.start,a),a);}}});onloadRegister(function(){function a(event){var b=event.getTarget();var c=parseInt(b.getAttribute('maxlength'),10);if(c>0&&DOM.isNode(b,['input','textarea']))Input.enforceMaxLength.bind(Input,b,c).defer();}Event.listen(document.documentElement,{keydown:a,paste:a});});
add_properties('Input',{setMaxLength:function(a,b){if(b>0){a.setAttribute('maxlength',b);Input.enforceMaxLength(a,b);}else a.removeAttribute('maxlength');}});
function TextInputControl(b){this.parent.construct(this,b);var a=this.getRoot();var c=function(){this.update.bind(this).defer();}.bind(this);Event.listen(a,{keydown:c,paste:c});}TextInputControl.extend('DOMControl');TextInputControl.prototype={setMaxLength:function(a){Input.setMaxLength(this.getRoot(),a);return this;},getValue:function(){return Input.getValue(this.getRoot());},isEmpty:function(){return Input.isEmpty(this.getRoot());},setValue:function(a){Input.setValue(this.getRoot(),a);this.update();return this;},clear:function(){return this.setValue('');},setPlaceholderText:function(a){Input.setPlaceholder(this.getRoot(),a);return this;}};
function TextMetrics(a){this._node=a;var b=this._shadow=$N('textarea',{className:'textMetrics'});var c=['fontSize','fontStyle','fontWeight','fontFamily','lineHeight','wordWrap'];c.each(function(d){CSS.setStyle(b,d,CSS.getStyle(a,d));});document.body.appendChild(b);}TextMetrics.prototype={measure:function(){var a=this._node;var b=this._shadow;var c=a.clientWidth-CSS.getStyleFloat(a,'paddingLeft')-CSS.getStyleFloat(a,'paddingRight');CSS.setStyle(b,'width',c+'px');b.value=a.value+'...';return {width:b.scrollWidth,height:b.scrollHeight};},destroy:function(){DOM.remove(this._shadow);}};
function TextAreaControl(a){this.autogrow=false;this.parent.construct(this,a);this.width=null;Event.listen(a,{focus:this._handleFocus.bind(this)});}TextAreaControl.extend('TextInputControl');TextAreaControl.mixin('Arbiter',{setAutogrow:function(a){this.autogrow=a;return this;},onupdate:function(){this.parent.onupdate();if(this.autogrow){var d=this.getRoot();if(!this.metrics)this.metrics=new TextMetrics(d);if(typeof this.minHeight==='undefined'){var c=CSS.getStyleFloat(d,'height');this.minHeight=c>0?c:d.offsetHeight-8;}var b=this.metrics.measure();var a=Math.max(this.minHeight,b.height);if(a!=this.height){CSS.setStyle(d,'height',a+'px');this.height=a;Arbiter.inform('reflow');this.inform('resize');}}else if(this.metrics){this.metrics.destroy();this.metrics=null;}},resetHeight:function(){this.height=-1;this.update();},_handleFocus:function(){this.width=null;}});
function URLScraper(a){this.input=a;this.enable();}URLScraper.mixin('Arbiter',{reset:function(){this.lastMatch=null;},enable:function(){if(this.events)return;var a=function(b){setTimeout(this.check.bind(this,b),30);};this.events=Event.listen(this.input,{paste:a.bind(this,false),keydown:a.bind(this,true)});},disable:function(){if(!this.events)return;for(var event in this.events)this.events[event].remove();this.events=null;},check:function(b){var c=this.input.value;if(b&&URLScraper.trigger(c))return;var a=URLScraper.match(c);if(a&&a!=this.lastMatch){this.lastMatch=a;this.inform('match',{url:a});}}});(function(){var a='!"#$%&\'()*+,-./:;<=>?@[\\]^_`{|}~',q='\u2000-\u206F\u00ab\u00bb';var n='(?:(?:ht|f)tps?)://',f='(?:(?:\\d{1,3}[.]){3}\\d{1,3})',r='(?:\\b)www\\d{0,3}[.]',i='[^\\s'+a+q+']',g='(?:(?:[.:\\-_%@]|'+i+')*'+i+')',o='(?:[.][a-z]{2,4})',m='(?::\\d+){0,1}',c='(?=[\/?#])';var e='(?:'+'(?:'+n+g+m+')|'+'(?:'+f+m+')|'+'(?:'+r+g+o+m+')|'+'(?:'+g+o+m+c+')'+')';var d='[\/#?]',b='\\([^\\s()<>]+\\)',k='[^\\s()<>'+q+']+',j='[^\\s'+a+q+']';var l='(?:'+'(?:'+d+')'+'(?:'+'(?:'+b+'|'+k+')*'+'(?:'+b+'|'+j+')'+')*'+')*';var h=new RegExp('('+'(?:'+e+')'+'(?:'+l+')'+')','im');var p=/[\s'";]/;URLScraper.match=function(s){return (h.exec(s)||[])[1]||null;};URLScraper.trigger=function(s){return !p.test(s.charAt(s.length-1));};})();
function rand32(){return Math.floor(Math.random()*4294967295);}function verifyNumber(a){if(typeof a=='undefined'||isNaN(a)||a==Number.POSITIVE_INFINITY||a==Number.NEGATIVE_INFINITY)a=0;return a;}
function htmlspecialchars(a){if(typeof(a)=='undefined'||a===null||!a.toString)return '';if(a===false){return '0';}else if(a===true)return '1';return a.toString().replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#039;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}function htmlize(a){return htmlspecialchars(a).replace(/\n/g,'<br />');}function escape_js_quotes(a){if(typeof(a)=='undefined'||!a.toString)return '';return a.toString().replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/\r/g,'\\r').replace(/"/g,'\\x22').replace(/'/g,'\\\'').replace(/</g,'\\x3c').replace(/>/g,'\\x3e').replace(/&/g,'\\x26');}
function html_hyperlink(g,h,i,e){if(typeof g==='undefined'||!g.toString)return '';if(typeof h!=='function')h=htmlize;if(typeof i!=='function')i=htmlize;var g=g.toString();var f=[];var b;while((b=URLScraper.match(g))){var d=g.indexOf(b);if(d>=0)f.push(h(g.substring(0,d)));var a=i(b);var c=b.replace(/"/g,'%22');if(!(/^[a-z][a-z0-9\-+.]+:\/\//i.test(b)))c='http://'+c;f.push('<a target="_blank" rel="nofollow" href="'+c+'"');if(e)f.push(' onmousedown="UntrustedLink.bootstrap(this, \''+Env.lhsh+'\', event)"');f.push('>'+a+'</a>');g=g.substring(d+b.length);}g&&f.push(h(g));return f.join('');}function nl2br(a){if(typeof(a)=='undefined'||!a.toString)return '';return a.toString().replace(/\n/g,'<br />');}function is_email(a){return /^([\w!.%+\-])+@([\w\-])+(?:\.[\w\-]+)+$/.test(a);}
add_properties('Hovercard',{active:{},init:function(){if(ua.ie()<7)return;Event.listen(document.documentElement,'mouseover',this.handle.bind(this));},handle:function(event){var a=Parent.byTag(event.getTarget(),'a');if((a||!this.isShowing)&&this.setActive(a)){(this.process||this.bootload).call(this,a);event.stop();}},bootload:function(a){this.bootload=bagofholding;Bootloader.loadComponents(['hovercard-core'],function(){if(a==this.active.node)this.process(a);}.bind(this));},getEndpoint:function(a){return a.getAttribute('data-hovercard');},isActive:function(a){return a&&this.isShowing&&this.active.node==a;},setActive:function(b){if(!this.isActive(b)){var a;if(!b||!(a=this.getEndpoint(b))){this.active={};return false;}if(this.active.node!=b){this.active.moveToken&&this.active.moveToken.remove();this.active={node:b,endpoint:a,pos:null};}}return true;}});onloadRegister(Hovercard.init.bind(Hovercard));
function Poller(b,a){this._requestCallback=a;this.setTimePeriod(b);}Poller.MIN_TIME_PERIOD=2000;copy_properties(Poller.prototype,{stop:function(){clearTimeout(this._token);this._token=null;this._cancelRequest();},scheduleRequest:function(){this.stop();if(this._timePeriod)this._token=this._makeRequest.bind(this).defer(this._timePeriod);},requestNow:function(){this.stop();this._makeRequest();},_timePeriod:null,setTimePeriod:function(a){a=a||null;if(a&&(isNaN(a)||a<Poller.MIN_TIME_PERIOD))return;if(a&&this._timePeriod==null)this._token=this._makeRequest.bind(this).defer(a);this._timePeriod=a;},_makeRequest:function(){this._cancelRequest();if(!this._isLoadUser())return;var b=new AsyncRequest();var a=true;b.setInitialHandler(function(){return a;});this._cancelRequest=function(){a=false;};b.setFinallyHandler(this.scheduleRequest.bind(this));b.setInitialHandler=bagofholding;b.setFinallyHandler=bagofholding;this._requestCallback(b);if(a)b.send();},_isLoadUser:function(){return Env.user==getCookie('c_user');},_cancelRequest:bagofholding,getTimePeriod:function(){return this._timePeriod;}});
function XHPTemplate(a){this.model=a;}XHPTemplate.prototype={render:function(){if(HTML.isHTML(this.model))this.model=DOM.setContent(document.createDocumentFragment(),this.model)[0];return this.model.cloneNode(true);}};(function(){var a='XHPTemplate:nodes';copy_properties(XHPTemplate,{getNode:function(c,b){return XHPTemplate.getNodes(c)[b];},getNodes:function(e){var d=DataStore.get(e,a);if(!d){d={};var f=DOM.scry(e,'[data-jsid]');f.push(e);var b=f.length;while(b--){var c=f[b];d[c.getAttribute('data-jsid')]=c;c.removeAttribute('data-jsid');}DataStore.set(e,a,d);}return d;}});})();
onloadRegister(function(){Event.listen(document.documentElement,'submit',function(b){var a=b.getTarget().getElementsByTagName('*');for(var c=0;c<a.length;c++)if(a[c].getAttribute('required')&&Input.isEmpty(a[c])){a[c].focus();return false;}},Event.Priority.URGENT);});
var PrivacyBaseValue={FACEBOOK_EMPLOYEES:112,CUSTOM:111,OPEN:100,EVERYONE:80,NETWORKS_FRIENDS_OF_FRIENDS:60,NETWORKS_FRIENDS:55,FRIENDS_OF_FRIENDS:50,ALL_FRIENDS:40,SELF:10,NOBODY:0};var PrivacyFriendsValue={EVERYONE:80,NETWORKS_FRIENDS:55,FRIENDS_OF_FRIENDS:50,ALL_FRIENDS:40,SOME_FRIENDS:30,SELF:10,NO_FRIENDS:0};var PrivacySpecialPreset={ONLY_CORP_NETWORK:200,COLLEGE_NETWORK_FRIENDS_OF_FRIENDS:201,COLLEGE_NETWORK_FRIENDS:202};var PrivacyNetworkTypes={TYPE_COLLEGE:1,TYPE_HS:2,TYPE_CORP:3,TYPE_GEO:4,TYPE_MANAGED:14,TYPE_TEST:50};var PrivacyNetworksAll=1;copy_properties(PrivacyBaseValue,PrivacySpecialPreset);function PrivacyModel(){this.value=PrivacyBaseValue.ALL_FRIENDS;this.friends=PrivacyFriendsValue.NO_FRIENDS;this.networks=[];this.objects=[];this.lists=[];this.lists_x=[];this.list_anon=0;this.ids_anon=[];this.list_x_anon=0;this.ids_x_anon=[];this.tdata={};return this;}copy_properties(PrivacyModel.prototype,{init:function(k,a,h,i,f,g,d,b,e,c,j){this.value=k;this.friends=a;this.networks=h.clone();this.objects=i.clone();this.lists=f.clone();this.lists_x=g.clone();this.list_anon=d;this.ids_anon=b.clone();this.list_x_anon=e;this.ids_x_anon=c.clone();j=j||{};copy_properties(this.tdata,j);},clone:function(){var a=new PrivacyModel();a.init(this.value,this.friends,this.networks,this.objects,this.lists,this.lists_x,this.list_anon,this.ids_anon,this.list_x_anon,this.ids_x_anon,this.tdata);return a;},getData:function(){var b=['value','friends','networks','objects','lists','lists_x','list_anon','ids_anon','list_x_anon','ids_x_anon'];var d={};for(var c=0;c<b.length;++c){var a=b[c];d[a]=this[a];}return d;}});
var Menu=function(){var i='menu:mouseover';var a=null;function b(k){return Parent.byClass(k,'uiMenu');}function c(k){return Parent.byClass(k,'uiMenuItem');}function d(k){if(document.activeElement){var l=c(document.activeElement);return k.indexOf(l);}return -1;}function e(k){return DOM.find(k,'a.itemAnchor');}function f(k){return CSS.hasClass(k,'checked');}function g(k){return !CSS.hasClass(k,'disabled');}function h(event){var k=c(event.getTarget());k&&Menu.focusItem(k);}function j(k){Menu.inform(Menu.ITEM_SELECTED,{menu:b(k),item:k});}onloadRegister(function(){var k={};k.click=function(event){var n=c(event.getTarget());if(n&&g(n)){j(n);var l=e(n);var m=l.href;var o=l.getAttribute('rel');return (o&&o!=='ignore')||(m&&m.charAt(m.length-1)!=='#');}};k.keydown=function(event){var u=event.getTarget();if(!a||DOM.isNode(u,['input','textarea']))return;var q=Event.getKeyCode(event);switch(q){case KEYS.UP:case KEYS.DOWN:var m=Menu.getEnabledItems(a);var o=d(m);Menu.focusItem(m[o+(q===KEYS.UP?-1:1)]);return false;case KEYS.SPACE:var t=c(u);if(t){j(t);event.prevent();}break;default:var l=String.fromCharCode(q).toLowerCase();var p=Menu.getEnabledItems(a);var o=d(p);var n=o;var r=p.length;while((~o&&(n=++n%r)!==o)||(!~o&&++n<r)){var s=Menu.getItemLabel(p[n]);if(s&&s.charAt(0).toLowerCase()===l){Menu.focusItem(p[n]);return false;}}}};Event.listen(document.body,k);});return copy_properties(new Arbiter(),{ITEM_SELECTED:'menu/item-selected',ITEM_TOGGLED:'menu/item-toggled',focusItem:function(k){if(k){this._removeSelected(b(k));CSS.addClass(k,'selected');g(k)&&e(k).focus();}},getEnabledItems:function(k){return Menu.getItems(k).filter(g);},getCheckedItems:function(k){return Menu.getItems(k).filter(f);},getItems:function(k){return DOM.scry(k,'li.uiMenuItem');},getItemLabel:function(k){return k.getAttribute('data-label',2)||'';},isItemChecked:function(k){return CSS.hasClass(k,'checked');},register:function(k){k=b(k);if(!DataStore.get(k,i))DataStore.set(k,i,Event.listen(k,'mouseover',h));a=k;},setItemEnabled:function(l,k){if(!k&&!DOM.scry(l,'span.disabledAnchor')[0])DOM.appendContent(l,$N('span',{className:DOM.find(l,'a').className+' disabledAnchor'},HTML(e(l).innerHTML)));CSS.conditionClass(l,'disabled',!k);},toggleItem:function(l){var k=!Menu.isItemChecked(l);CSS.conditionClass(l,'checked',k);e(l).setAttribute('aria-checked',k);Menu.inform(Menu.ITEM_TOGGLED,{menu:b(l),item:l,checked:k});},unregister:function(l){l=b(l);var k=DataStore.remove(l,i);k&&k.remove();a=null;this._removeSelected(l);},_removeSelected:function(k){Menu.getItems(k).filter(function(l){return CSS.hasClass(l,'selected');}).each(function(l){CSS.removeClass(l,'selected');});}});}();
function Toggler(){this.init();}(function(){var d=[];var b;function c(){c=bagofholding;Event.listen(document.documentElement,'click',function(event){var f=event.getTarget();var e=Dialog.getCurrent();d.each(function(g){g.active&&!g.sticky&&!DOM.contains(g.getActive(),f)&&!g.inTargetFlyout(f)&&(!e||DOM.contains(e.getRoot(),g.getActive()))&&g.hide();});},Event.Priority.URGENT);}function a(f,e){if(f instanceof Toggler)return f;return Toggler.getInstance(e);}Toggler.mixin('Arbiter',{init:function(){this.active=null;this.togglers={};this.setSticky(false);d.push(this);this.subscribe(['show','hide'],Toggler.inform.bind(Toggler));c();},show:function(g){var e=a(this,g);var h=e.active;if(g!==h){h&&e.hide();e.active=g;CSS.addClass(g,'openToggler');var f=DOM.scry(g,'a[rel="toggle"]');if(f.length>0&&f[0].getAttribute('data-target'))CSS.removeClass(ge(f[0].getAttribute('data-target')),'toggleTargetClosed');DOM.appendContent(g,e.getToggler('next'));DOM.prependContent(g,e.getToggler('prev'));e.inform('show',e);}},hide:function(h){var f=a(this,h);var e=f.active;if(e&&(!h||h===e)){CSS.removeClass(e,'openToggler');var g=DOM.scry(e,'a[rel="toggle"]');if(g.length>0&&g[0].getAttribute('data-target'))CSS.addClass(ge(g[0].getAttribute('data-target')),'toggleTargetClosed');values(f.togglers).each(DOM.remove);f.inform('hide',f);f.active=null;}},toggle:function(f){var e=a(this,f);if(e.active===f){e.hide();}else e.show(f);},getActive:function(){return a(this).active;},inTargetFlyout:function(h){var g=a(this).active;var f=DOM.scry(g,'a[rel="toggle"]');var e=null;if(f.length>0&&f[0].getAttribute('data-target'))e=ge(f[0].getAttribute('data-target'));return e&&DOM.contains(e,h);},getToggler:function(f){var e=a(this);if(!e.togglers[f])e.togglers[f]=$N('button',{className:'hideToggler',onfocus:function(){var g=DOM.scry(e.active,'a[rel="toggle"]')[0];g&&g.focus();e.hide();}});return this.togglers[f];},setSticky:function(f){var e=a(this);f=f!==false;if(f!==e.sticky){e.sticky=f;if(f){e._pt&&Arbiter.unsubscribe(e._pt);}else e._pt=Arbiter.subscribe('page_transition',e.hide.bind(e,null));}return e;}});copy_properties(Toggler,Toggler.prototype);copy_properties(Toggler,{bootstrap:function(e){var f=e.parentNode;Toggler.getInstance(f).toggle(f);},createInstance:function(f){var e=new Toggler().setSticky(true);DataStore.set(f,'toggler',e);return e;},getInstance:function(f){while(f){var e=DataStore.get(f,'toggler');if(e)return e;f=f.parentNode;}return (b=b||new Toggler());},listen:function(g,f,e){return Toggler.subscribe($A(g),function(i,h){if(h.getActive()===f)return e(i,h);});},subscribe:(function(e){return function(g,f){g=$A(g);if(g.contains('show'))d.each(function(h){if(h.getActive())f.curry('show',h).defer();});return e(g,f);};})(Toggler.subscribe.bind(Toggler))});})();
var TooltipLink={setTooltipText:function(a,b){a=Parent.byClass(a,'uiTooltip');if(a)DOM.setContent(DOM.find(a,'span.uiTooltipText'),b);},setTooltipEnabled:function(b,a){b=Parent.byClass(b,'uiTooltip');b&&CSS.conditionClass(b,'uiTooltipDisabled',!a);}};
var Selector=function(){var a;var i=false;function b(k){return Parent.byClass(k,'uiSelector');}function c(k){return Parent.byClass(k,'uiSelectorButton');}function e(k){return DOM.scry(k,'select')[0];}function d(k){return DOM.find(k,'div.uiSelectorMenuWrapper');}function f(){f=bagofholding;Menu.subscribe(Menu.ITEM_SELECTED,function(k,m){if(!a||!m||m.menu!==Selector.getSelectorMenu(a))return;var n=g(a);var p=h(m.item);if(p){var l=a;var o=Selector.isOptionSelected(m.item);var q=Selector.inform('select',{selector:l,option:m.item});if(q===false)return;if(n||!o){Selector.setSelected(l,Selector.getOptionValue(m.item),!o);Selector.inform('toggle',{selector:l,option:m.item});Selector.inform('change',{selector:l});if(j(l))DataStore.set(l,'dirty',true);}}if(!n||!p)a&&Selector.toggle(a);});}function g(k){return !!k.getAttribute('data-multiple');}function h(k){return CSS.hasClass(k,'uiSelectorOption');}function j(k){return !!k.getAttribute('data-autosubmit');}onloadRegister(function(){var k={};k.keydown=function(event){var m=event.getTarget();if(DOM.isNode(m,['input','textarea']))return;switch(Event.getKeyCode(event)){case KEYS.DOWN:case KEYS.SPACE:case KEYS.UP:i=true;if(c(m)){var l=b(m);Selector.toggle(l);return false;}break;case KEYS.ESC:i=true;if(a){Selector.toggle(a);return false;}break;case KEYS.RETURN:i=true;break;}};k.keyup=function(){!function(){i=false;}.defer();};Event.listen(document.body,k);Toggler.subscribe(['show','hide'],function(t,s){var p=b(s.getActive());if(p){f();var m=Selector.getSelectorButton(p);var n=Selector.getSelectorMenu(p);var q=t==='show';if(q){a=p;if(CSS.hasClass(m,'uiButtonDisabled')){Selector.setEnabled(p,false);return false;}if(!n){var l=m.getAttribute('ajaxify');if(l){var u=HTML('<div class="uiSelectorMenuWrapper uiToggleFlyout">'+'<div class="uiMenu uiSelectorMenu loading">'+'<ul class="uiMenuInner">'+'<li><span></span></li>'+'</ul>'+'</div>'+'</div>');DOM.appendContent(m.parentNode,u);Bootloader.loadComponents('async',function(){AsyncRequest.bootstrap(l,m);});n=Selector.getSelectorMenu(p);}}if(n){Menu.register(n);if(i){var o=Menu.getCheckedItems(n);if(!o.length)o=Menu.getEnabledItems(n);Menu.focusItem(o[0]);}}}else{a=null;n&&Menu.unregister(n);i&&m.focus();if(j(p)&&DataStore.get(p,'dirty')){var r=DOM.scry(p,'input.submitButton')[0];r&&r.click();DataStore.remove(p,'dirty');}}CSS.conditionClass(Selector.getSelectorButton(p),'selected',q);Selector.inform(q?'open':'close',{selector:p});}});});return copy_properties(new Arbiter(),{attachMenu:function(o,k,m){o=b(o);if(o){a&&Menu.unregister(Selector.getSelectorMenu(a));DOM.setContent(d(o),k);a&&Menu.register(Selector.getSelectorMenu(o));if(m){var l=o.getAttribute('data-name');l&&m.setAttribute('name',l);if(!g(o))m.setAttribute('multiple',false);var n=e(o);if(n){DOM.replace(n,m);}else DOM.insertAfter(o.firstChild,m);}return true;}},getOption:function(m,n){var l=Selector.getOptions(m),k=l.length;while(k--)if(n===Selector.getOptionValue(l[k]))return l[k];return null;},getOptions:function(l){var k=Menu.getItems(Selector.getSelectorMenu(l));return k.filter(h);},getEnabledOptions:function(l){var k=Menu.getEnabledItems(Selector.getSelectorMenu(l));return k.filter(h);},getSelectedOptions:function(k){return Menu.getCheckedItems(Selector.getSelectorMenu(k));},getOptionText:function(k){return Menu.getItemLabel(k);},getOptionValue:function(l){var n=b(l);var m=e(n);var k=Selector.getOptions(n).indexOf(l);return k>=0?m.options[k+1].value:'';},getSelectorButton:function(k){return DOM.find(k,'a.uiSelectorButton');},getSelectorMenu:function(k){return DOM.scry(k,'div.uiSelectorMenu')[0];},getValue:function(o){var m=e(o);if(!m)return null;if(!g(o))return m.value;var p=[];var l=m.options;for(var k=1,n=l.length;k<n;k++)if(l[k].selected)p.push(l[k].value);return p;},isOptionSelected:function(k){return Menu.isItemChecked(k);},listen:function(l,m,k){return this.subscribe(m,function(o,n){if(n.selector===l)return k(n,o);});},setButtonLabel:function(n,l){var k=Selector.getSelectorButton(n);var m=parseInt(k.getAttribute('data-length'),10);l=l||k.getAttribute('data-label')||'';Button.setLabel(k,l);if(typeof l==='string'){CSS.conditionClass(k,'uiSelectorBigButtonLabel',l.length>m);if(m&&l.length>m){k.setAttribute('title',l);}else k.removeAttribute('title');}},setButtonTooltip:function(m,l){var k=Selector.getSelectorButton(m);TooltipLink.setTooltipText(k,l||k.getAttribute('data-tooltip')||'');},setEnabled:function(l,k){if(!k&&a&&b(l)===a)Selector.toggle(l);Button.setEnabled(Selector.getSelectorButton(l),k);},setOptionEnabled:function(l,k){Menu.setItemEnabled(l,k);},setSelected:function(o,p,m){m=m!==false;var l=Selector.getOption(o,p);if(!l)return;var k=Selector.isOptionSelected(l);if(m!==k){if(!g(o)&&!k){var n=Selector.getSelectedOptions(o)[0];n&&Menu.toggleItem(n);}Menu.toggleItem(l);Selector.updateSelector(o);}},toggle:function(k){Toggler.toggle(DOM.scry(b(k),'div.wrap')[0]);},updateSelector:function(u){var r=Selector.getOptions(u);var t=Selector.getSelectedOptions(u);var o=e(u).options;var q=[];for(var n=0,p=r.length;n<p;n++){var s=t.contains(r[n]);o[n+1].selected=s;if(s)q.push(Selector.getOptionText(r[n]));}o[0].selected=!t.length;var l=CSS.hasClass(u,'uiSelectorDynamicLabel');var m=CSS.hasClass(u,'uiSelectorDynamicTooltip');if(l||m){if(g(u)){var k=Selector.getSelectorButton(u);q=q.join(k.getAttribute('data-delimiter'));}l&&Selector.setButtonLabel(u,q);m&&Selector.setButtonTooltip(u,q);}}});}();
function BasePrivacyWidget(){}BasePrivacyWidget.mixin('Arbiter',{init:function(a,c,b){this._controllerId=a;this._root=$(a);this._options=copy_properties(b||{},c||{});this._formDataKey='privacy_data';},getData:function(){return this._model.getData();},_getPrivacyData:function(a){a=a||this._fbid;var b={};b[a]=this.getData();return b;},getRoot:function(){return this._root;},_initSelector:function(a){this._selector=a;Selector.listen(a,'select',function(b){var c=b.option;if(CSS.hasClass(c,'notSelectable'))return;var d=Selector.getOptionValue(c);this._onMenuSelect(d);}.bind(this));Event.listen(a,'click',function(){this.inform('menuActivated');}.bind(this));},_isCustomSetting:function(a){return (a==PrivacyBaseValue.CUSTOM);},_updateSelector:function(a){var b=this._model.objects;if(b&&b.length){selected_value=b[0];}else selected_value=this._model.value;Selector.setSelected(this._selector,selected_value+'');Arbiter.inform(UIPrivacyWidget.GLOBAL_PRIVACY_UPDATED_SELECTOR,{id:this._controllerId,value:selected_value});if(!this._isCustomSetting(selected_value))return;var c=Selector.getOption(this._selector,PrivacyBaseValue.CUSTOM+'');if(c)c.setAttribute('data-label',a||_tx("Custom"));Selector.updateSelector(this._selector);},_onPrivacyChanged:function(){this._saveFormData();Arbiter.inform('Form/change',{node:this.getRoot()});this.inform('privacyChanged',this.getData());Arbiter.inform(UIPrivacyWidget.GLOBAL_PRIVACY_CHANGED_EVENT,{fbid:this._fbid,data:this.getData()});},_saveFormData:function(){var b=DOM.find(this._root,'div.UIPrivacyWidget_Form');DOM.empty(b);var a={};if(this._options.useLegacyFormData){a[this._formDataKey]=this.getData();}else a[this._formDataKey]=this._getPrivacyData();Form.createHiddenInputs(a,b);}});
function UIPrivacyWidget(){this.parent.construct(this);}copy_properties(UIPrivacyWidget,{GLOBAL_PRIVACY_CHANGED_EVENT:'UIPrivacyWidget/globalPrivacyChanged',GLOBAL_PRIVACY_UPDATED_SELECTOR:'UIPrivacyWidget/globalUpdatedSelector',instances:{},getInstance:function(a){return this.instances[a];}});UIPrivacyWidget.extend('BasePrivacyWidget');UIPrivacyWidget.mixin('Arbiter',{init:function(i,a,b,h,c,e,g){var f={autoSave:false,saveAsDefaultFbid:0,initialExplanation:'',useLegacyFormData:false,composerEvents:false,everyoneOrFriendsOnly:false};if(b=='0')b=0;this.parent.init(a,g,f);this._lists=c;this._networks=e;this._fbid=b;this._row=h;this._groups={};this._showingDialog=false;this._includeOnlyMe=Selector.getOption(i,PrivacyBaseValue.SELF+'')!==null;for(var d in e)this._groups[e[d].fbid]=d;UIPrivacyWidget.instances[this._controllerId]=this;this._initSelector(i);this.setData(this._row,this._options.initialExplanation,true);this._saveFormData();if(this._options.composerEvents=='resettodefault'){Arbiter.subscribe('composer/publish',this.resetToDefault.bind(this));}else if(this._options.composerEvents=='savetodefault')Arbiter.subscribe('composer/publish',this.saveToDefault.bind(this));},resetToDefault:function(){this._model=this._originalModel.clone();this._modelClone=this._originalModel.clone();this._updateSelector(this._options.initialExplanation);this._saveFormData();return this;},saveToDefault:function(){this._modelClone=this._model.clone();this._saveFormData();},revert:function(){this._model=this._modelClone.clone();this._updateSelector(this._previousDescription);this._saveFormData();return this;},getValue:function(){return this._model.value;},getDefaultValue:function(){return this._originalModel.value;},isEveryonePrivacy:function(){return this._model.value==PrivacyBaseValue.EVERYONE;},dialogOpen:function(){return this._dialog&&this._dialog.getRoot();},setData:function(b,a,c){this._model=new PrivacyModel();this._model.init(b.value,b.friends,b.networks,b.objects,b.lists,b.lists_x,b.list_anon,b.ids_anon,b.list_x_anon,b.ids_x_anon,b.tdata);this._modelClone=this._model.clone();if(c)this._originalModel=this._model.clone();this._previousDescription=a;this._customModel=null;this._updateSelector(a);},setLists:function(a){this._lists=a;return this;},setNetworks:function(a){this._networks=a;return this;},_isCustomSetting:function(a){if(this._options.everyoneOrFriendsOnly){return (a!=PrivacyBaseValue.EVERYONE&&a!=PrivacyBaseValue.ALL_FRIENDS);}else return (a==PrivacyBaseValue.CUSTOM||a==PrivacyBaseValue.SELF&&!this._includeOnlyMe);},_onMenuSelect:function(b){this._modelClone=this._model.clone();var a=this._isCustomSetting(this._model.value);var c=this._isCustomSetting(b);if(a&&!c)this._customModel=this._model.clone();if(!(a&&c)){this._model.value=b;this._resetModelAuxiliaryData();}if(b==PrivacyBaseValue.CUSTOM){if(this._customModel){this._model=this._customModel.clone();}else if(this._modelClone.value!=PrivacyBaseValue.CUSTOM)this._model.friends=PrivacyFriendsValue.ALL_FRIENDS;this._showDialog();}else{if(this._groups[b]){this._model=new PrivacyModel();this._model.value=PrivacyBaseValue.CUSTOM;this._model.objects=[b];}this._onPrivacyChanged();if(this._options.autoSave)this._saveSetting();}this._updateSelector();},_showDialog:function(){this._showingDialog=true;if(!this._fbid){this._model.list_x_anon=0;this._model.list_anon=0;}var a={controller_id:this._controllerId,privacy_data:this.getData(),fbid:this._fbid,save_as_default_fbid:this._options.saveAsDefaultFbid};this._dialog=new Dialog().setAsync(new AsyncRequest('/ajax/privacy/privacy_widget_dialog.php').setData(a)).setModal(true).show();return false;},_resetModelAuxiliaryData:function(){if(this._model.value!=PrivacyBaseValue.CUSTOM){this._model.lists_x=this._model.lists=this._model.networks=this._model.ids_anon=this._model.ids_x_anon=[];this._model.list_x_anon=0;this._model.list_anon=0;}},_saveSetting:function(a){a=a||this._fbid;new AsyncRequest('/ajax/privacy/widget_save.php').setData({privacy_data:this._getPrivacyData(a),old_privacy_data:this._modelClone.getData(),fbid:a}).setHandler(this._handleResponse.bind(this)).setErrorHandler(this._handleError.bind(this)).send();},_handleResponse:function(b){var a=b.getPayload();this.setData(a.privacy_row,a.explanation);},_handleError:function(a){AsyncResponse.defaultErrorHandler(a);this.revert();},_updateButtonIcon:function(){var d=Selector.getSelectedOptions(this._selector)[0];if(d){var c=DOM.scry(d,'.img')[0];var a=Selector.getSelectorButton(this._selector);if(c){Button.setIcon(a,c.cloneNode(true));}else{var b=DOM.scry(a,'.img')[0];b&&DOM.remove(b);}}},_updateSelector:function(a){this.parent._updateSelector(a);if(this._options.dynamicIcon)this._updateButtonIcon();}});
var TypeaheadUtil=(function(){var b=/[ ]+/g;var c=/[^ ]+/g;var a=/[.,+*?$|#{}()\^\-\[\]\\\/!@%'"~=<>_:;\u2010\u2011\u2012\u2013\u2014\u2015\u30fb]/g;var d={};var p={a:"\u0430 \u00e0 \u00e1 \u00e2 \u00e3 \u00e4 \u00e5",b:"\u0431",c:"\u0446 \u00e7 \u010d",d:"\u0434 \u00f0 \u010f \u0111",e:"\u044d \u0435 \u00e8 \u00e9 \u00ea \u00eb \u011b",f:"\u0444",g:"\u0433 \u011f",h:"\u0445 \u0127",i:"\u0438 \u00ec \u00ed \u00ee \u00ef \u0131",j:"\u0439",k:"\u043a \u0138",l:"\u043b \u013e \u013a \u0140 \u0142",m:"\u043c",n:"\u043d \u00f1 \u0148 \u0149 \u014b",o:"\u043e \u00f8 \u00f6 \u00f5 \u00f4 \u00f3 \u00f2",p:"\u043f",r:"\u0440 \u0159 \u0155",s:"\u0441 \u015f \u0161 \u017f",t:"\u0442 \u0165 \u0167 \u00fe",u:"\u0443 \u044e \u00fc \u00fb \u00fa \u00f9 \u016f",v:"\u0432",y:"\u044b \u00ff \u00fd",z:"\u0437 \u017e",ae:"\u00e6",oe:"\u0153",ts:"\u0446",ch:"\u0447",ij:"\u0133",sh:"\u0448",ss:"\u00df",ya:"\u044f"};for(var l in p){var f=p[l].split(' ');for(var h=0;h<f.length;h++)d[f[h]]=l;}function e(q){return q?q.replace(a,' '):'';}function g(t){t=(''+t).toLowerCase();var s='';var q='';for(var r=t.length;r--;){q=t.charAt(r);s=(d[q]||q)+s;}return s.replace(b,' ');}function n(q,r){return r.length-q.length;}function o(s,r){s=e(g(s));var t=[];var q=c.exec(s);while(q){q=q[0];t.push(q);q=c.exec(s);}r&&t.sort(n);return t;}function j(s,t,r){var q={};return t.every(function(v){for(var u=0;u<r.length;++u){var w=r[u];if(!q[u]&&(w==v||(s&&w.indexOf(v)===0)))return (q[u]=true);}return false;});}var i=j.curry(false);var k=j.curry(true);var m={flatten:g,tokenize:o,isExactMatch:i,isPrefixMatch:k};return m;})();
add_properties('TypeaheadBehaviors',{buildBestAvailableNames:function(a){var b=a.getView();b.subscribe('beforeRender',function(c,e){var g=TypeaheadUtil.tokenize(e.value,true);for(var d=0;d<e.results.length;++d){if(e.results[d].localized_text==null)continue;var f=TypeaheadUtil.tokenize(e.results[d].localized_text);if(TypeaheadUtil.isPrefixMatch(g,f)){e.results[d].text=e.results[d].localized_text;}else e.results[d].text=e.results[d].untranslated_text;}});}});
var UFICommentLike={showDetails:function(a,b,c){c.onmouseover=bagofholding;new AsyncRequest().setURI('/ajax/like/tooltip.php').setData({comment_fbid:a,comment_from:b}).setHandler(function(d){TooltipLink.setTooltipText(c,d.getPayload().like_sentence);}).setErrorHandler(bagofholding).send();}};
var UFIOptimistic={COMMENT_SEND_EVENT:'ufi/comment',_commentSeqNo:0,init:function(a){this._commentTemplate=a;if(!this._loaded){Event.listen(document.documentElement,'click',this._clickHandler.bind(this),Event.Priority.URGENT);this._loaded=true;}},_clickHandler:function(event){var i=event.getTarget();var l=i.name=='comment'&&i.parentNode&&Parent.byClass(i,'optimistic_submit');if(!l)return true;var e=i.form;var k=DOM.find(e,'textarea');if(Input.isEmpty(k))return true;fc_uncollapse(e);var a=this._commentTemplate.render();var j=XHPTemplate.getNode(a,'text');DOM.setContent(j,HTML(htmlize(trim(k.value))));var c=DOM.scry(e,'ul.commentList')[0];if(!c)return true;CSS.show(c.parentNode);c.appendChild(a);var b=c.lastChild;var g=rand32();b.id='optimistic_comment_'+g+'_'+this._commentSeqNo++;var d=Form.serialize(e);d.comment_replace=b.id;d.comment=1;function h(){new AsyncRequest(Form.getAttribute(e,'action')).setData(d).setRelativeTo(e).setErrorHandler(function(m){CSS.addClass(b,'uiUfiCommentFailed');AsyncResponse.defaultErrorHandler(m);}).send();}Event.listen(XHPTemplate.getNode(a,'retry_link'),'click',h);h();k.value=k.style.height='';k.focus();var f=window.MentionsInput&&MentionsInput.getInstance(k);f&&f.reset();Arbiter.inform(UFIOptimistic.COMMENT_SEND_EVENT,{form:e});return false;}};
onloadRegister(function(){Selector.subscribe('close',function(a,b){if(CSS.hasClass(b.selector,'commentHideSelector')){var c=Selector.getValue(b.selector);c&&Selector.setSelected.curry(b.selector,c,false).defer();}});});
function MentionsInput(a){DataStore.set(a,'MentionsInput',this);this._root=a;}MentionsInput.getInstance=function(a){var b=Parent.byClass(a,'uiMentionsInput');return b?DataStore.get(b,'MentionsInput'):null;};(function(){var a='@\\uff20';var e='.,+*?$|#{}()\\^\\-\\[\\]\\\\\/!@%&\'"~=<>_:;';var d='\\b[A-Z][^ A-Z'+e+']';var c='(?:['+a+']([^'+a+e+']{0,20}))';var b='(?:(?:'+d+'+)|'+c+')';var f='(?:'+d+'{4,})';MentionsInput.prototype={_matcher:new RegExp(c+'$'),_autoMatcher:new RegExp(b+'$'),_userMatcher:new RegExp(f+'$')};})();MentionsInput.mixin('Arbiter',{init:function(a,b){this.init=bagofholding;this._initialized=true;this._typeahead=Typeahead.getInstance(DOM.find(this._root,'.mentionsTypeahead'));this._highlighter=DOM.find(this._root,'.highlighter');this._highlighterInner=this._highlighter.firstChild;this._highlighterContent=DOM.find(this._root,'.highlighterContent');this._hiddenInput=DOM.find(this._root,'.mentionsHidden');this._input=this._typeahead.getCore().getElement();this._maxMentions=a.max||6;if(ua.firefox()<4){this._input.blur();setTimeout(function(){this._input.focus();}.bind(this));}if(!this._hiddenInput.name){var c=this._input.name;this._input.name=c+'_text';this._hiddenInput.name=c;}this._initEvents();this._initTypeahead();this.reset(b);this.inform('init',null,Arbiter.BEHAVIOR_STATE);},reset:function(b){if(!this._initialized)return;this._mentioned={};this._numMentioned=0;this._filterData=null;this._hiddenInput&&(this._hiddenInput.value='');this._highlighterContent&&DOM.empty(this._highlighterContent);this._highlighterAuxContent&&DOM.remove(this._highlighterAuxContent);this._highlighterAuxContent=null;CSS.setStyle(this._typeahead.getElement(),'height','auto');if(b){Input.setValue(this._input,b.flattened);for(var a in b.mention_data)this._addToken({uid:a,text:b.mention_data[a],type:'unknown'});}this._updateTypeahead();this._update();},getRawValue:function(){return Input.getValue(this._hiddenInput);},getTypeahead:function(){return this._typeahead;},_initEvents:function(){var c=this._update.bind(this);var a=c.defer.bind(c,20);var b={change:c,keydown:a,focus:this._updateWidth.bind(this)};if(ua.firefox())b.keyup=c;if(ua.firefox()<4){b.keypress=b.keydown;delete b.keydown;}Event.listen(this._input,b);},_initTypeahead:function(){this._typeahead.subscribe('select',function(c,d){var e=d.selected;this._addToken({uid:e.uid,text:e.text,type:e.type});this.updateValue();}.bind(this));var a=this._input;var b=null;this._typeahead.subscribe('render',function(event){if(b===null){b=Input.getSubmitOnEnter(a);Input.setSubmitOnEnter(a,false);}});this._typeahead.subscribe('reset',function(event){if(b!==null){Input.setSubmitOnEnter(a,b);b=null;}});this._typeahead.subscribe('query',function(){this._filterData=null;}.bind(this));this._typeahead.getCore().suffix='';this._typeahead.getData().setFilter(this._filterResults.bind(this));},_filterResults:function(d){if(this._filterData===null){var a=Input.getSelection(this._input).start||0;for(var c=0;c<this._offsets.length;c++){var e=this._offsets[c];if(a>e[0]&&a<=e[1]){this._filterData={caretIsInsideMention:true};return false;}}var b=this._typeahead.getCore();this._filterData={value:b.getValue(),rawValue:b.getRawValue()};}if(this._filterData.caretIsInsideMention)return false;if(this._matcher.test(this._filterData.rawValue))return true;if(d.type!='user'&&!d.auto)return false;if(this._userMatcher.test(this._filterData.value))return true;return TypeaheadUtil.isExactMatch(TypeaheadUtil.tokenize(this._filterData.value),d.preparedTokens);},_addToken:function(a){this._mentioned[a.uid]=a;this._numMentioned++;this._updateTypeahead();},_removeToken:function(a){delete this._mentioned[a];this._numMentioned--;this._updateTypeahead();},_reduceToken:function(f,d){var e=d.split(' ');var b=[];for(var a=0;a<e.length;a++)if(f.indexOf(e[a])!=-1)b.push(e[a]);e=b;for(a=1;a<e.length;a++)for(var c=1;c<e[a-1].length+1;c++)if(f.indexOf(e[a-1].substr(0,c)+e[a])!=-1)e.splice(a-1,1);while(f.indexOf(e.join(' '))==-1)e.splice(0,1);return e.join(' ');},_update:function(){var a=Input.getValue(this._input);if(a==this._value)return;this._value=a;this._updateTokens();this.updateValue();},_updateTokens:function(){var e=Input.getValue(this._input);for(var d in this._mentioned){var a=this._mentioned[d];var c=a.text;var b;if(a.type=='user'&&(b=this._reduceToken(e,c))!==''){a.text=b;}else if(!c||e.indexOf(c)==-1||typeof c!=='string')this._removeToken(d);}},updateValue:function(){var g=Input.getValue(this._input);var c=this._mentioned;var d=[];var b,e,f;var a=this._input.value;for(f in c){e=c[f].text;g=g.replace(e,function(h,i){d.push([i,i+e.length]);return e;});}for(f in c){e=c[f].text;g=g.replace(e,'@['+f+':]');a=a.replace(e,'@['+f+':]');}b=htmlize(a);for(f in c){e=c[f].text;b=b.replace('@['+f+':]','<b>'+htmlize(e)+'</b>');g=g.replace('@['+f+':]','@['+f+':'+e+']');}if(ua.ie())b=b.replace(/ {2}/g,'&nbsp; ');this._offsets=d;this._hiddenInput.value=g;DOM.setContent(this._highlighterContent,HTML(b));this._updateHeight();},_updateWidth:function(){var a=CSS.getStyleFloat.curry(this._input);var b=this._input.offsetWidth-a('paddingLeft')-a('paddingRight')-a('borderLeftWidth')-a('borderRightWidth');if(ua.firefox())b-=2;if(ua.ie()<=7){b-=CSS.getStyleFloat(this._highlighterInner,'paddingLeft');this._highlighter.style.zoom=1;}this._highlighterInner.style.width=Math.max(b,0)+'px';},_updateHeight:function(){if(this._highlighterAuxContent){var a=this._highlighter.offsetHeight;var b=this._typeahead.getElement();if(a>b.offsetHeight){CSS.setStyle(b,'height',a+'px');Arbiter.inform('reflow');}}},_updateTypeahead:function(){var a=this._typeahead.getCore();var b=null;if(!this._maxMentions||this._numMentioned<this._maxMentions)b=this._autoMatcher;a.matcher=b;a.setExclusions(keys(this._mentioned));this.inform('update',{mentioned:this._mentioned});},setAuxContent:function(a){if(this._highlighterContent){if(!this._highlighterAuxContent){this._highlighterAuxContent=$N('span',{className:'highlighterAuxContent'});DOM.insertAfter(this._highlighterContent,this._highlighterAuxContent);}DOM.setContent(this._highlighterAuxContent,a);this._updateHeight();}}});
function DataSource(a){this._maxResults=a.maxResults||10;this.token=a.token;this.queryData=a.queryData||{};this.queryEndpoint=a.queryEndpoint||'';this.bootstrapData=a.bootstrapData||{};this.bootstrapEndpoint=a.bootstrapEndpoint||'';this._exclusions=a.exclusions||[];this._indexedFields=a.indexedFields||['text','tokens'];this._minExactMatchLength=4;}DataSource.mixin('Arbiter',{events:['activity','query','respond'],init:function(){this.init=bagofholding;this._fields=Object.from(this._indexedFields);this._activeQueries=0;this.dirty();},dirty:function(){this.value=this.flatValue='';this._bootstrapped=false;this._data={};this.localCache={};this.queryCache={};},bootstrap:function(){if(this._bootstrapped)return;this.fetch(this.bootstrapEndpoint,this.bootstrapData,{token:this.token});this._bootstrapped=true;},query:function(f,c,a){this.inform('beforeQuery',{value:f});var b=TypeaheadUtil.flatten(f);var e=this.buildUids(b,[],a);var d=this.respond(f,e).filter(function(g){return g.type!='calltoaction';});this.value=f;this.flatValue=b;this.inform('query',{value:f,results:d});if(c||!b||!this.queryEndpoint||this.getQueryCache().hasOwnProperty(b)||!this.shouldFetchMoreResults(d))return false;this.inform('queryEndpoint',{value:f});this.fetch(this.queryEndpoint,this.getQueryData(f,e),{value:f,flat_value:b,exclusions:a});return true;},shouldFetchMoreResults:function(a){return a.length<this._maxResults;},getQueryData:function(c,b){var a=copy_properties({value:c},this.queryData||{});b=b||[];if(b.length)a.existing_ids=b.join(',');return a;},setQueryData:function(a,b){if(b)this.queryData={};copy_properties(this.queryData,a);return this;},getExclusions:function(){return $A(this._exclusions);},setExclusions:function(a){this._exclusions=a||[];},setFilter:function(a){this.filter=a;},respond:function(d,c,a){var b=this.buildData(c);this.inform('respond',{value:d,results:b,isAsync:!!a});return b;},asyncErrorHandler:bagofholding,fetch:function(c,b,d){if(!c)return;var a=new AsyncRequest().setURI(c).setData(b).setMethod('GET').setReadOnly(true).setHandler(function(e){this.fetchHandler(e,d||{});}.bind(this)).setFinallyHandler(function(){this._activeQueries--;if(!this._activeQueries)this.inform('activity',{activity:false});}.bind(this));a.setErrorHandler(this.asyncErrorHandler);this.inform('beforeFetch',{request:a});a.send();if(!this._activeQueries)this.inform('activity',{activity:true});this._activeQueries++;},fetchHandler:function(e,c){var f=c.value;var d=c.flat_value;var b=c.exclusions;this.addEntries(e.getPayload().entries,f,d);this.inform('fetchComplete',{response:e,value:f});this.respond(f,this.buildUids(d,[],b),true);if(!f&&c.token&&e.getPayload().token!==c.token){var a=copy_properties({},this.bootstrapData);a.token=this.token;this.fetch(this.bootstrapEndpoint,a);}},addEntries:function(b,f,c){var d=this.processEntries($A(b||[]),f);var a=this.buildUids(c,d);if(f){var e=this.getQueryCache();e[c]=a;}else this.fillCache(a);},processEntries:function(a,b){return a.map(function(e,d){var f=(e.uid=e.uid+'');var c=this.getEntry(f);if(!c){c=e;this.setEntry(f,c);}else copy_properties(c,e);c.query=b;c.index===undefined&&(c.index=d);return f;},this);},getAllEntries:function(){return this._data||{};},getEntry:function(a){return this._data[a]||null;},setEntry:function(b,a){this._data[b]=a;},fillCache:function(b){var a=this.localCache;b.each(function(g){var d=this.getEntry(g);if(!d||d.bootstrapped)return;d.bootstrapped=true;var f=this.getTokens(d);for(var c=0,e=f.length;c<e;++c){var h=f[c];if(!a.hasOwnProperty(h))a[h]=[];a[h].push(g);}},this);},getTokens:function(c){if(c.preparedTokens)return c.preparedTokens;var d=[];for(var b in this._fields){var a=c[b];if(a)d.push(a.join?a.join(' '):a);}return (c.preparedTokens=TypeaheadUtil.tokenize(d.join(' ')));},mergeUids:function(a,c,b,e){var d=function(f,g){return this.getEntry(f).index-this.getEntry(g).index;}.bind(this);return a.sort(d).concat(c,b);},buildUids:function(i,d,a){if(!d)d=[];if(!i)return d;if(!a)a=[];var g=TypeaheadUtil.tokenize(i,true);var b=this.buildCacheResults(i,g,this.localCache);var f=this.buildQueryResults(i,g);var e=this.mergeUids(b,f,d,g);var h=Object.from(a.concat(this._exclusions));var c=e.filter(function(j){if(h.hasOwnProperty(j)||!this.getEntry(j))return false;if(this.filter&&!this.filter(this.getEntry(j)))return false;return (h[j]=true);},this);return this.uidsIncludingExact(i,c,h);},uidsIncludingExact:function(g,d,f){var e=d.length;if(g.length<this._minExactMatchLength||e<=this._maxResults)return d;for(var c=0;c<e;++c){var a=this.getEntry(d[c]);a.text_lower||(a.text_lower=a.text.toLowerCase());if(a.text_lower===g){if(c>=this._maxResults){var b=d.splice(c,1);d.splice(this._maxResults-1,0,b);}break;}}return d;},buildData:function(d){var c=[];var b=Math.min(d.length,this._maxResults);for(var a=0;a<b;++a)c.push(this.getEntry(d[a]));return c;},findQueryCache:function(e){var b=0;var a=null;var d=this.getQueryCache();for(var c in d)if(e.indexOf(c)==0&&c.length>b){b=c.length;a=c;}return d[a]||[];},buildQueryResults:function(c,b){var a=this.findQueryCache(c);if(this.getQueryCache().hasOwnProperty(c))return a;return this.filterQueryResults(b,a);},filterQueryResults:function(b,a){return a.filter(function(c){return TypeaheadUtil.isPrefixMatch(b,this.getTokens(this.getEntry(c)));},this);},buildCacheResults:function(o,l,a){var j=l.length;var g={};var n={};var h=[];for(var e=0;e<j;++e){var k=l[e];for(var i in a)if(!g.hasOwnProperty(i)&&i.indexOf(k)===0){g[i]=true;var d=a[i];for(var f=0,c=d.length;f<c;++f){var m=d[f];if(e===0||(n.hasOwnProperty(m)&&n[m]==e))n[m]=e+1;}}}for(var b in n)if(n[b]==j)h.push(b);return h;},getQueryCache:function(){return this.queryCache;},setMaxResults:function(a){this._maxResults=a;this.value&&this.respond(this.value,this.buildUids(this.flatValue));}});
function Typeahead(b,d,a,c){this.args={data:b,view:d,core:a};DataStore.set(c,'Typeahead',this);this.element=c;}Typeahead.getInstance=function(a){var b=Parent.byClass(a,'uiTypeahead');return b?DataStore.get(b,'Typeahead'):null;};Typeahead.mixin('Arbiter',{init:function(a){this.init=bagofholding;this.getCore();this.proxyEvents();this.initBehaviors(a||[]);this.inform('init',this);this.data.bootstrap();this.core.focus();},getData:function(){if(!this.data){var a=this.args.data;this.data=a;this.data.init();}return this.data;},getView:function(){if(!this.view){var a=this.args.view;this.view=new window[a.ctor](a.node,a.options||{});this.view.init();}return this.view;},getCore:function(){if(!this.core){var a=this.args.core;this.core=new window[a.ctor](a.options||{});this.core.init(this.getData(),this.getView(),this.getElement());}return this.core;},getElement:function(){return this.element;},swapData:function(b){var a=this.core;this.data=this.args.data=b;b.init();if(a){a.data=b;a.initData();a.reset();}b.bootstrap();return b;},proxyEvents:function(){[this.data,this.view,this.core].each(function(a){a.subscribe(a.events,this.inform.bind(this));},this);},initBehaviors:function(a){if(window.TypeaheadBehaviors)a.each(function(b){(TypeaheadBehaviors[b]||bagofholding)(this);},this);}});
function TypeaheadCore(a){copy_properties(this,a);}TypeaheadCore.mixin('Arbiter',{events:['blur','focus','unselect'],keepFocused:true,resetOnSelect:false,setValueOnSelect:false,queryTimeout:250,preventFocusChangeOnTab:false,init:function(b,d,c){this.init=bagofholding;this.data=b;this.view=d;this.root=c;this.element=DOM.find(c,'.textInput');var a=DOM.scry(this.element,'input')[0];if(a)this.element=a;this.inputWrap=DOM.find(c,'div.wrap');this.hiddenInput=DOM.find(c,'input.hiddenInput');this.value='';this.selectedText=null;if(this.setValueOnSelect&&CSS.hasClass(this.inputWrap,'selected'))this.selectedText=this.getValue();this.initView();this.initData();this.initEvents();this.initToggle();this._exclusions=[];},initView:function(){this.view.subscribe('highlight',function(){this.element.focus();}.bind(this));this.view.subscribe('select',function(a,b){this.select(b.selected);}.bind(this));this.view.subscribe('afterSelect',function(){this.afterSelect();}.bind(this));},initData:function(){this.data.subscribe('respond',function(a,b){if(b.value==this.getValue()&&!this.element.disabled)this.view.render(b.value,b.results,b.isAsync);}.bind(this));this.data.subscribe('activity',function(a,b){this.fetching=b.activity;if(!this.fetching)this.nextQuery&&this.performQuery();}.bind(this));},initEvents:function(){Event.listen(this.view.getElement(),{mouseup:this.viewMouseup.bind(this),mousedown:this.viewMousedown.bind(this)});var a={blur:bind(this,'blur'),focus:bind(this,'focus'),click:bind(this,'click'),keyup:bind(this,'keyup'),keydown:bind(this,'keydown')};if(ua.firefox())a.text=a.keyup;if(ua.firefox()<4){a.keypress=a.keydown;delete a.keydown;}Event.listen(this.element,a);Event.listen(this.element,'keypress',this.keypress.bind(this));},initToggle:function(){var b=this.root.parentNode;var d=CSS.getStyle(b,'position')!='static'?b:this.root;var c=this.view;var a='uiTypeaheadFocused';this.subscribe('focus',function(){c.show();CSS.addClass(d,a);});this.subscribe('blur',function(){c.hide();CSS.removeClass(d,a);});},viewMousedown:function(){this.selecting=true;},viewMouseup:function(){this.selecting=false;},blur:function(){if(this.selecting){this.selecting=false;return;}this.inform('blur');},click:function(){this.element.select();},focus:function(){this.checkValue();this.inform('focus');},keyup:function(){if(!this.getValue())this.view.reset();this.checkValue();},keydown:function(event){if(!this.view.isVisible()||this.view.isEmpty()){this.checkValue.bind(this).defer();return;}switch(Event.getKeyCode(event)){case KEYS.TAB:this.handleTab(event);return;case KEYS.UP:this.view.prev();break;case KEYS.DOWN:this.view.next();break;case KEYS.ESC:this.view.reset();break;default:this.checkValue.bind(this).defer();return;}event.kill();},keypress:function(event){if(this.view.getSelection()&&Event.getKeyCode(event)==KEYS.RETURN){this.view.select();event.kill();}},handleTab:function(event){this.view.select();this.preventFocusChangeOnTab&&event.kill();},select:function(a){if(a&&this.setValueOnSelect){this.setValue(a.text);this.setHiddenValue(a.uid);this.selectedText=a.text;CSS.addClass(this.inputWrap,'selected');}},afterSelect:function(){this.resetOnSelect?this.reset():this.view.reset();this.keepFocused?this.element.focus():this.element.blur();},unselect:function(){if(this.setValueOnSelect){this.selectedText=null;CSS.removeClass(this.inputWrap,'selected');}this.setHiddenValue();this.inform('unselect',this);},setEnabled:function(b){var a=b===false;this.element.disabled=a;CSS.conditionClass(this.root,'uiTypeaheadDisabled',a);},reset:function(){this.unselect();this.setValue();!this.keepFocused&&Input.reset(this.element);this.view.reset();this.inform('reset');},getElement:function(){return this.element;},setExclusions:function(a){this._exclusions=a;},getExclusions:function(){return this._exclusions;},setValue:function(a){this.value=this.nextQuery=a||'';Input.setValue(this.element,this.value);},setHiddenValue:function(a){this.hiddenInput.value=(a||a===0)?a:'';Arbiter.inform('Form/change',{node:this.hiddenInput});},getValue:function(){return Input.getValue(this.element);},getHiddenValue:function(){return this.hiddenInput.value||'';},checkValue:function(){var c=this.getValue();if(c==this.value)return;if(this.selectedText&&this.selectedText!=c)this.unselect();var b=+new Date();var a=b-this.time;this.time=b;this.value=this.nextQuery=c;this.performQuery(a);},performQuery:function(a){if(this.selectedText)return;a=a||0;if(this.fetching&&a<this.queryTimeout){this.data.query(this.nextQuery,true,this._exclusions);}else{this.data.query(this.nextQuery,false,this._exclusions);this.nextQuery=null;}}});
function TypeaheadAreaCore(a){this.parent.construct(this,a);this.matcher=new RegExp(this.matcher+'$');this.preventFocusChangeOnTab=true;}TypeaheadAreaCore.extend('TypeaheadCore');TypeaheadAreaCore.prototype={prefix:'',suffix:', ',matcher:"\\b[^,]*",click:bagofholding,select:function(a){this.parent.select(a);var e=this.element.value;var d=this.prefix+a.text+this.suffix;this.expandBounds(e,d);var b=e.substring(0,this.start);var c=e.substring(this.end);this.element.value=b+d+c;Input.setSelection(this.element,b.length+d.length);},expandBounds:function(g,f){g=g.toLowerCase().trim();f=f.toLowerCase();var b,e,c,d;var a=/\s/;e=g.substring(this.start,this.end);c=f.indexOf(e);b=this.start;while(b>=0&&c>=0){d=g.charAt(b-1);if(!d||a.test(d))this.start=b;e=d+e;c=f.indexOf(e);b--;}e=g.substring(this.start,this.end);c=f.indexOf(e);b=this.end;while(b<=g.length&&c>=0){d=g.charAt(b);if(!d||a.test(d))this.end=b;e=e+d;c=f.indexOf(e);b++;}},getRawValue:function(){var a=Input.getSelection(this.element).start||0;return this.parent.getValue().substring(0,a);},getValue:function(){var a=this.matcher&&this.matcher.exec(this.getRawValue());if(!a)return '';this.start=a.index;this.end=a.index+a[0].length;return a[1]||a[0];}};
function TypeaheadView(a,b){this.element=$(a);copy_properties(this,b);}TypeaheadView.mixin('Arbiter',{events:['highlight','render','reset','select'],renderer:'basic',autoSelect:false,init:function(){this.init=bagofholding;this.initializeEvents();this.reset();},initializeEvents:function(){Event.listen(this.element,{mouseup:this.mouseup.bind(this),mouseover:this.mouseover.bind(this)});},getElement:function(){return this.element;},mouseup:function(event){this.select(true);event.kill();},mouseover:function(event){if(this.visible)this.highlight(this.getIndex(event));},reset:function(a){if(!a)this.disableAutoSelect=false;this.index=-1;this.items=[];this.results=[];this.value='';this.element.innerHTML='';this.inform('reset');return this;},getIndex:function(event){return this.items.indexOf(Parent.byTag(event.getTarget(),'li'));},getSelection:function(){var a=this.results[this.index]||null;return this.visible?a:null;},isEmpty:function(){return !this.results.length;},isVisible:function(){return this.visible;},show:function(){CSS.show(this.element);this.visible=true;return this;},hide:function(){CSS.hide(this.element);this.visible=false;return this;},render:function(h,e,f){this.value=h;if(!e.length){this.reset(true);return;}var c={results:e,value:h};this.inform('beforeRender',c);e=c.results;var d=this.getDefaultIndex(e);if(this.index>0&&this.index!==this.getDefaultIndex(this.results)){var a=this.results[this.index];for(var b=0,g=e.length;b<g;++b)if(a.uid==e[b].uid){d=b;break;}}this.results=e;this.element.innerHTML=this.buildMarkup(e);this.items=this.getItems();this.highlight(d,false);this.inform('render',e);},getItems:function(){return DOM.scry(this.element,'li');},buildMarkup:function(c){var b,a=[];if(typeof this.renderer=="function"){a.push('<ul>');b=this.renderer;}else{a.push('<ul class="'+this.renderer+'">');b=TypeaheadRenderers[this.renderer];}c.each(function(d,e){a=a.concat(b.call(this,d,e));},this);a.push('</ul>');return a.join('');},getDefaultIndex:function(b){var a=(this.autoSelect&&!this.disableAutoSelect);return this.index<0&&!a?-1:0;},next:function(){this.highlight(this.index+1);},prev:function(){this.highlight(this.index-1);},highlight:function(a,b){this.selected&&CSS.removeClass(this.selected,'selected');if(a>this.items.length-1){a=-1;}else if(a<-1)a=this.items.length-1;if(a>=0&&a<this.items.length){this.selected=this.items[a];CSS.addClass(this.selected,'selected');}this.index=a;this.disableAutoSelect=(a==-1);if(b!==false)this.inform('highlight',{index:a,selected:this.results[a]});},select:function(a){var b=this.index,c=this.results[b];if(c){this.inform('select',{index:b,clicked:!!a,selected:c});this.inform('afterSelect');}}});
add_properties('TypeaheadBehaviors',{hoistFriends:function(a){var b=a.getView();b.subscribe('beforeRender',function(c,f){var g=[];var d=[];for(var e=0;e<f.results.length;++e){var h=f.results[e];if(h.type=='user'&&h.bootstrapped){d.push(h);}else g.push(h);}f.results=d.concat(g);});}});
add_properties('TypeaheadBehaviors',{showLoadingIndicator:function(a){a.subscribe('activity',function(b,c){CSS.conditionClass(a.getElement(),'typeaheadLoading',c.activity);});}});
add_properties('TypeaheadRenderers',{basic:function(b,d){var f=b.markup||htmlize(b.text);var e=htmlize(b.subtext);var c=b.icon;var a='';if(b.type)a=' class="'+b.type+'"';return ['<li',a,'>',(c?'<img src="'+c+'" alt=""/>':''),(f?'<span class="text">'+f+'</span>':''),(e?'<span class="subtext">'+e+'</span>':''),'</li>'];}});
add_properties('TypeaheadRenderers',{compact:function(c,e){var h=c.markup||htmlize(c.text),g=htmlize(c.subtext),a=htmlize(c.category),f=c.photo,b='',d=[];if(f)if(f instanceof Array){d=['<span class="splitpics clearfix">','<span class="splitpic leftpic">','<img src="',f[0],'" alt="" />','</span>','<span class="splitpic">','<img src="',f[1],'" alt="" />','</span>','</span>'];}else d=['<img src="',f,'" alt="" />'];if(c.type)b=' class="'+c.type+'"';return ['<li',b,'>',d.join(''),(h?'<span class="text">'+h+'</span>':''),'<div class="details"><span class="detailsContents">',(a?a:''),(g&&a?' &middot ':''),(g?g:''),'</span></div>','</li>'];}});